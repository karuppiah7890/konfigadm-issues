Set ntp/chronyd - https://github.com/flanksource/konfigadm/issues/13

Acceptance criteria:

Want the ability to make sure it is installed, and specify the ntp servers to use. Like this

```yaml
ntp:
  - ntp.ubuntu.org
  - ntp.1.ubunutu.org
```

This would ensure that ntpd is installed, and the service is enabled and running, with the specified servers configured in ntp.conf

----------

chronyd? not needed. we can start with ntp. chrony is more specific to rhel, and we don't have e2e setup for rhel yet

----------

tasks:
1. install ntp server in ubuntu

https://vitux.com/how-to-install-ntp-server-and-client-on-ubuntu/

```
$ sudo apt install ntp
```

2. configure some ntp servers. how to check if the configuration is working?

```
$ sudo vi /etc/ntp.conf
```

https://www.ntppool.org/en/
https://www.ntppool.org/zone
https://www.ntppool.org/zone/@
https://www.ntppool.org/zone/asia
https://www.ntppool.org/zone/in

```
server 0.in.pool.ntp.org
server 1.in.pool.ntp.org
server 2.in.pool.ntp.org
server 3.in.pool.ntp.org
```

```
$ sudo service ntp restart
$ sudo service ntp status
```

To print a list of the peers

```
$ ntpq -p
```

what about configuration of NTP clients? defer it for now..

3. write code to install ntp (looks like it's usually already installed) and to configure
it using /etc/ntp.conf

- check where is the code to install other packages
- how is the installation happening?
- how is the declarativeness maintained or done?
- add code for ntp installation
- check if there's any code to configure software using files


-----

there is some code for installing packages here and there already.

pkg/types/packages.go
pkg/phases/packages.go

to know supported OSes and base OSes , check here
pkg/phases/os.go

on checking how the packages are installed, I used the execution of the apply command
to see how it happened. this is what I found till now -

the command I executed is this -

```
$ sudo konfigadm apply -c - <<-EOF
kubernetes:
  version: 1.17.2
container_runtime:
  type: docker
commands:
  - kubeadm init
EOF
```

from this, it was able to read from the standard input and install a lot of packages. how ?

first the file to start checking is here - 
cmd/apply.go

the config flag is defined here at root level
main.go

using the flag value(s), the GetConfig over here
cmd/common.go

is called to get the configuration

In our case, we didn't use other flags, so I think it's mostly this code for config

```
cfg, err := types.NewConfig(append(configs, args...)...).
		WithVars(vars...).
		WithFlags(flags...).
		Build()
```

it looks like a builder pattern? the main function to look for is Build() here
pkg/types/builder.go

here, each config from the config(s) is taken and then merged into one, using ImportConfig() func calls
over here
pkg/types/config.go

Now, the Config struct here
pkg/types/types.go

already has NTP field in it! so NTP can already be read!

but in the ImportConfig() method, NTP was not considered at all for the merge. So I added this code

But hey, I wanted to add tests for this too. To make sure that everything is tested and works too. TDD!
So I removed the one line of code I added and started looking for tests! And then found this

test/merge_test.go

Added a small test there after creating a fixture file here
fixtures/ntp.yml

Need to understand what fixture means and how it all works here, but I wrote a failing test and then
passed it too! :D

Next in line is to make sure that, when ntp config is given, make sure ntp is installed
and configured too with the given set of ntp servers! :D

Wow, okay, looks like there's a lot of code to do a lot of things. So, today, on digging some code
for apply command, I found out some more stuff -

The ApplyPhases() method on Config does a lot of stuff! It's here
pkg/types/config.go

To start with, there are phases. On checking where all the phases are, I found it here
finally
pkg/phases.go

And as you can see, there's order to it, and it works in that order. Example, Kubernetes
comes first, and Packages come later

And kubernetes is an app, packages is not

On checking the methods on these phases, I checked ApplyPhase method, as that's what is
called in ApplyPhases function.

for kubernetes, it does some stuff based on the OS, over here
pkg/apps/kubernetes.go in ApplyPhase function

You can see how OS based packages are added and file system stuff is also done
And you can also see that ntp is installed too!

In our case, for our issue, we still have to install it - because it's not
necessary that our user will be installing kubernetes. If they simply give
ntp config, only that will be installed and configured. 

The systemd config to run it is here

```
$ cat /lib/systemd/system/ntp.service
[Unit]
Description=Network Time Service
Documentation=man:ntpd(8)
After=network.target
Conflicts=systemd-timesyncd.service

[Service]
Type=forking
# Debian uses a shell wrapper to process /etc/default/ntp
# and select DHCP-provided NTP servers if available
ExecStart=/usr/lib/ntp/ntp-systemd-wrapper
PrivateTmp=true

[Install]
WantedBy=multi-user.target
```

In fedora, it can be installed via

```
$ yum install ntp
```

and the configuration was at `/etc/ntp.conf`


Now, looks like this is what I gotta do - create a ntp.go near kubernetes.go 
May be add some tests? And create a Apply phase, verify phase? and then add the ntp
phase to the list of phases! 

To install ntp -> install ntp package, add systemd config, add a config file - actually, overwrite
the existing file that came with installation. should we add all the default config along with
the ntp servers? should it be templatized or something? hmm. may be ;) let's see...

or we can append to the config file? :) But there's no provision for that now, I think

For now, let's write to the file. We can append later! :)

Now, in our test, what should we test?
1. We need to have ntp package installed, so that should be there in the packages list
  a. there should be one package - done
  b. the package should have flags - what flags? DEBIAN_LIKE or what? both debian and ubuntu
     have that tag as common. choosing DEBIAN_LIKE for now :) we are supporting only Ubuntu and Debian for
     now - done
2. We need to add a systemd config file. so that should be there in the file system - actually, the installation itself adds it in ubuntu. so, let's not add it now may be?
3. We need to add a ntp config file. so that should be there in the file system - done
4. We need to run some commands to start/restart ntp service. so that should be there in the commands - done

tests are done. Now try it in ubuntu and debian and see how it works! :D

Okay, so it didn't work - reason being, the systemctl restart command was run first, the apt commands
came later. since restart failed, as ntp was not yet installed, the whole process stopped there.

one solution to this is - define the systemd file - let it overwrite the existing one. make sure systemctl
stuff runs later - check this. lets support just ubuntu and debian for now and worry about other OSes later!

I was actually thinking of pre commands and post commands. But then I wasn't sure pre or before of what,
post or after of what? in my case it was apt installation, but we need to make it more clear and I was 
thinking about that feature. looks like there are some more features and I've seen commands being mentioned 
in the config file itself - but I felt systemctl command should just automatically be run - also, we put in
the new conf file - for it to work and be used, we need to restart it. so yeah. And I just saw some more 
code in some places. Looks like I need to understand more about how systemctl related phase works and if 
I'll be able to make use of it, also, I just noticed some phases adding commands to the config instead of
returning it from the ApplyPhase function. Hmm. Let me read more code and see how best to run systemctl
command alone or add systemd file and run systemctl command after apt installation happens :)

Okay, on checking some code - I think I just need to add my systemctl command in the system post commands
which will then be taken up by a later phase - commands phase which will add it to the commands - at the 
endddd and then it will get executed at the end. the packages phase is before commands phase and the 
packages phase adds some commands I think - like apt, yum, etc based on the package manager of the OS.

Let me change my test to check the config Post commands rather than check the returned commands from the
ApplyPhases function

Okay wait, actually, the commands phase makes thee post commands on the config nil during it's phase.
So, the only way to check it is - check the commands returned yes, but I also need to make sure that it
comes after the apt command ðŸ¤” or else there will be no test change, but code change will be there. And for
both the code, the tests will pass. But only one of them is expected, the other is not. Hmm

Let's see how or if others have tested the post commands. Actually, in my case, I'm only installing the
ntp package. So, only systemctl command will be at the end. In the old code / wrong code, systemctl will be
at the first, which is wrong. Good. Let me just check that systemctl is the last thing on the commands 
array!

Okay, so now I've writte the test. For implementation, I need to add a post command to the config.
For this I'm planning to add a method similar to AddCommand called AddPostCommand. For which I'm first
writing a test. It's a simple function but I'm writing the test :P :)

Okay, wrote the test, passed it too, after making some mistakes :P while copy pasting AddCommand. I had to
add to the post commands! ðŸ™ˆ Finally added it to post commands, instead of commands :P And then went on to
the failing ntp test. passed it by using this method. Now, gonna compile and run and check! :D

okay, another issue occurred, this time apt install failed and it asked about overwriting the existing
/etc/ntp.conf file. And it failed because it was asking a question in an interactive manner but since
the program was running apt install, it failed. 

After some digging I realized that the files that ApplyPhase returns are written first, and then the
commands are run. This is why the /etc/ntp.conf is present before apt install is even run. This was being
an issue. There was no way I could write to files after running commands - without bringing in a new
feature in the ApplyPhases() method which calls all the phases and their ApplyPhase(). I had two options
in my mind - run a command to append to the /etc/ntp.conf - I thought may be we can reuse the default config
and then append to it too. Initially I thought about echo, but it had some permission issues, on checking
duckduckgo.com , I found out that `tee -a` could be used with sudo, and the content coming from echo - 
superuser.com/questions/136646/ddg#136653. So I thought - why not.  . And another thought was - store the
file from ApplyPhase with a differnent name and then move it, or in a location other than /etc/ntp.conf and 
then move it. What good place to keep a temp file other than /tmp/ and I didn't use random names. I 
realized that testing would become difficult too, so I just went with a fixed path to a file in /tmp/ 
directory and then put a post command to run the mv command first and then the systemctl commands next, so
that everything is smooth. And in this case, only the contents about the server url will be present in the
config file, and other default stuff would be gone and overwritten

I finally completed this and raised the PR and then saw some tests failing. And not my tests. I realized
something was wrong as all pipelines failed. And then I realized that it was my mistake - I was always 
running the ntp phase. ntp phase can only run when ntp has been configured. I wrote a test for that ( 
though I knew the code too :P ) and initially it was a failing test, and then I passed it! This new
test was about no ntp so I created a simple file which said "no-ntp.yml" and had only one echo command in
it and that's it.

Finally I fixed all the tests with that fix and pushed the PR and also pinged the maintainer

Also, one thing, one weird thing was - I returned nil for slice, map, and error. Had the same check in 
tests. But looks like somewhere the nils are converted to empty slice, empty map. error is still nil though.
So without changing the test code - which was passing finally, I changed all the code to return non nil 
stuff, except for error

The PR is here - https://github.com/flanksource/konfigadm/pull/54

Okay, @moshloop has asked if we can add a verify function to verify if the installation succeeded.
I think that's a good idea. Looks like other phases do it too. I vaguely seeing some verify stuff,
and I just checked again, so, VerifyPhase is an interface with the Verify method, so I'm going to be
implementing that. I'm currently checking how others are doing it and what the arguments mean, and
I also need to check what the return value means. 

The verification - I need to check if ntp service is running and healthy - how do I check that? ðŸ¤”
and I also need to verify that /etc/ntp.conf has the expected content - how do I do that? ðŸ¤” I could
just read the file :P and check the actual content and for expected content - use the function that
I used in the apply phase. I think that's a good idea.

I'm just left out with checking how to see if ntp service is up and running and healthy. Let me
see what other verify phases are doing :)

And I need to write tests for this first ðŸ™ˆ

Okay, wow, so there's this nice function called VerifyService that verifies if a service is running
or not. But I don't know how to write a test to mock this whole thing, or a part of it. The thing to
be tested is - has Verify been called or not.

I was thinking of what to do - I then decided to create an interface which has verify service method.
And then thought of using mock in test and actual in the code. While I was generating the mock code
with mockgen, I realized I will have to think about where to inject the mock

The NTP phase is a struct, I could insert there. But, that would mean anyone could set the value of it.
Also, the struct type ntp is small, not exposed, and it's only exposed as a Phase which has only one
function

I'm thinking I'll skip tests for these. It's going to be just a few lines of code. I could write an
internal test though - which is in the same package as the code. This way I can set the service verifier
and then test the code. Hmm. Let's do it? ðŸ¤” Let's see what moshloop has to say. If he says it's too much
I'll remove the test code, and keep the main code ;) :) No harm :)

I'm just having some go modules issues though - I need to use go 1.13.8 now - because the repo circle ci
config has that version only in the config. May be I could raise an issue upon the same! Requesting to move
to go 1.14

Anyways, looks like it was not the golang version. Looks like a module was actually not being used and
go mod tidy has been run only now

Also, I stumbled upon another issue - service running is not the only check. There's also a check
for the config file content. How can I create a config file in my laptop at /etc/ntp.conf ? Or I could
do it for the test. But it would require more permissions. Hmm. Testing this is turning out to be
harder than I thought. I mean, I actually didn't think about it at all. So, meh. Hmm. Usually in my team
we mock the file system too - we use afero and use a memory based file system. So, for the main code,
we use the OS file system

But file writing happens in Apply Phase. I think that's a lot now ðŸ¤” hmm

I'm thinking about the skipping the test. Hmm. And may be talk to moshloop about how we can tests for all
of these ;) And see if we can tidy up a bit, before writing those tests



To Do Later:
1. Append to the ntp.conf file instead of overwriting it
2. Support Fedora
3. add systemd config file if it's not present - it was noticed in fedora that
  systemd file was not there and service was not started. so, we need to run systemctl start command
  too. all this only for fedora. not sure about others.
